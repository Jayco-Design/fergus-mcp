<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers</title>
  <link rel="stylesheet" href="ui://shared/styles.css">
</head>
<body>
  <div class="container">
    <div id="customers-container">
      <!-- Initial loading state -->
      <div class="empty-state">
        <div class="empty-state-icon">‚è≥</div>
        <div class="empty-state-title">Loading customers...</div>
      </div>
    </div>
    <div id="pagination-container"></div>
  </div>

  <script>
    const SET_GLOBALS_EVENT_TYPE = 'openai:set_globals';

    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(' ');
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    function render() {
      // Access toolOutput from window.openai
      const toolOutput = window.openai?.toolOutput;

      if (!toolOutput) {
        console.log('[Fergus MCP] No toolOutput available yet');
        return;
      }

      const customers = toolOutput.customers || [];
      const pagination = toolOutput.pagination || {};

      console.log('[Fergus MCP] Rendering', customers.length, 'customers');

      const container = document.getElementById('customers-container');

      if (!customers || customers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <div class="empty-state-title">No customers found</div>
            <div class="empty-state-message">Try adjusting your search criteria</div>
          </div>
        `;
        return;
      }

      // Render as a grid of cards
      const html = `
        <div class="grid">
          ${customers.map(customer => {
            const initials = getInitials(customer.name);
            const hasContact = customer.email || customer.phone;
            const hasAddress = customer.address?.city || customer.address?.postalCode;

            return `
              <div class="customer-card">
                <div class="customer-card-header">
                  <div class="customer-card-avatar" aria-label="${escapeHtml(customer.name || 'Unknown')} avatar">
                    ${escapeHtml(initials)}
                  </div>
                  <div style="flex: 1; min-width: 0;">
                    <div class="customer-card-title">${escapeHtml(customer.name || 'Unnamed Customer')}</div>
                    <div class="customer-card-subtitle">ID: ${escapeHtml(customer.id?.toString() || 'N/A')}</div>
                  </div>
                </div>

                <div class="customer-card-body">
                  ${customer.email ? `
                    <div class="customer-card-row">
                      <svg class="customer-card-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M2 4l6 4 6-4M2 4v8h12V4M2 4h12" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <a href="mailto:${escapeHtml(customer.email)}" class="text-sm">
                        ${escapeHtml(customer.email)}
                      </a>
                    </div>
                  ` : ''}

                  ${customer.phone ? `
                    <div class="customer-card-row">
                      <svg class="customer-card-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M3 2h3l1 4-2 2c1 2 3 4 5 5l2-2 4 1v3a1 1 0 01-1 1C7 16 0 9 0 3a1 1 0 011-1z" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <span class="text-sm">${escapeHtml(customer.phone)}</span>
                    </div>
                  ` : ''}

                  ${hasAddress ? `
                    <div class="customer-card-row">
                      <svg class="customer-card-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M8 14s6-4 6-8a6 6 0 00-12 0c0 4 6 8 6 8z" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="8" cy="6" r="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <span class="text-sm">
                        ${escapeHtml([customer.address?.city, customer.address?.postalCode].filter(Boolean).join(', '))}
                      </span>
                    </div>
                  ` : ''}

                  ${!hasContact && !hasAddress ? `
                    <div class="customer-card-row text-tertiary">
                      <span class="text-sm">No contact information</span>
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      container.innerHTML = html;

      // Render pagination info
      if (pagination.count > 0) {
        const paginationContainer = document.getElementById('pagination-container');
        const totalText = pagination.total && pagination.total > pagination.count
          ? ` of ${pagination.total}`
          : '';
        paginationContainer.innerHTML = `
          <div class="pagination">
            <div class="pagination-info">
              Showing ${pagination.count}${totalText} customer${pagination.count !== 1 ? 's' : ''}
            </div>
          </div>
        `;
      }
    }

    // Listen for the set_globals event (fired when data updates)
    window.addEventListener(SET_GLOBALS_EVENT_TYPE, (event) => {
      console.log('[Fergus MCP] openai:set_globals event received');
      console.log('[Fergus MCP] event.detail.globals:', event.detail.globals);

      // Re-render when globals change
      render();
    });

    // Initial render on load (in case data is already available)
    console.log('[Fergus MCP] Template loaded');
    console.log('[Fergus MCP] window.openai:', window.openai);

    // Try rendering immediately if window.openai exists
    if (window.openai) {
      render();
    }
  </script>
</body>
</html>
