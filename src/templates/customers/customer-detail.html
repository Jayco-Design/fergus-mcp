<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Details</title>
  <link rel="stylesheet" href="../shared/styles.css">
</head>
<body>
  <div class="detail-container">
    <div id="customer-detail"></div>
  </div>

  <script>
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(' ');
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    function render(customer) {
      const container = document.getElementById('customer-detail');

      if (!customer || !customer.id) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <div class="empty-state-title">Customer not found</div>
            <div class="empty-state-message">The requested customer could not be loaded</div>
          </div>
        `;
        return;
      }

      const customerName = customer.name || customer.customerFullName || 'Unnamed Customer';
      const initials = getInitials(customerName);

      const html = `
        <!-- Header Section -->
        <div class="detail-header">
          <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
            <div class="customer-card-avatar" style="width: 64px; height: 64px; font-size: 24px;">
              ${escapeHtml(initials)}
            </div>
            <div>
              <h1 class="detail-title">${escapeHtml(customerName)}</h1>
              <div class="detail-subtitle">Customer ID: ${escapeHtml(customer.id?.toString() || 'N/A')}</div>
            </div>
          </div>
        </div>

        <!-- Contact Information Section -->
        ${renderContactSection()}

        <!-- Addresses Section -->
        ${renderAddressesSection()}
      `;

      container.innerHTML = html;
    }

    function renderContactSection() {
      const mainContact = customer.mainContact || {};
      const email = mainContact.email || customer.email;
      const phone = mainContact.phone || customer.phone;
      const contactName = mainContact.name;
      const position = mainContact.position;

      if (!email && !phone && !contactName && !position) {
        return '';
      }

      return `
        <div class="detail-section">
          <div class="detail-section-title">Contact Information</div>
          <div class="detail-section-content">
            ${contactName ? `
              <div class="detail-field">
                <span class="detail-field-label">Contact Name</span>
                <span class="detail-field-value">${escapeHtml(contactName)}</span>
              </div>
            ` : ''}

            ${position ? `
              <div class="detail-field">
                <span class="detail-field-label">Position</span>
                <span class="detail-field-value">${escapeHtml(position)}</span>
              </div>
            ` : ''}

            ${email ? `
              <div class="detail-field">
                <span class="detail-field-label">
                  <svg class="customer-card-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                    <path d="M2 4l6 4 6-4M2 4v8h12V4M2 4h12" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Email
                </span>
                <span class="detail-field-value">
                  <a href="mailto:${escapeHtml(email)}">${escapeHtml(email)}</a>
                </span>
              </div>
            ` : ''}

            ${phone ? `
              <div class="detail-field">
                <span class="detail-field-label">
                  <svg class="customer-card-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                    <path d="M3 2h3l1 4-2 2c1 2 3 4 5 5l2-2 4 1v3a1 1 0 01-1 1C7 16 0 9 0 3a1 1 0 011-1z" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Phone
                </span>
                <span class="detail-field-value">${escapeHtml(phone)}</span>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderAddressesSection() {
      const physicalAddress = customer.physicalAddress || customer.address;
      const postalAddress = customer.postalAddress;

      if (!physicalAddress && !postalAddress) {
        return '';
      }

      let html = '<div class="detail-section"><div class="detail-section-title">Addresses</div>';

      if (physicalAddress) {
        html += `
          <div class="detail-section-content mb-md">
            <div class="detail-field" style="border-bottom: none; padding-bottom: 0;">
              <span class="detail-field-label">
                <svg class="customer-card-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                  <path d="M8 14s6-4 6-8a6 6 0 00-12 0c0 4 6 8 6 8z" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="8" cy="6" r="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Physical Address
              </span>
            </div>
            <div style="padding-top: var(--spacing-sm); color: var(--color-text-primary);">
              ${formatAddress(physicalAddress)}
            </div>
          </div>
        `;
      }

      if (postalAddress && !addressesEqual(physicalAddress, postalAddress)) {
        html += `
          <div class="detail-section-content">
            <div class="detail-field" style="border-bottom: none; padding-bottom: 0;">
              <span class="detail-field-label">
                <svg class="customer-card-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                  <path d="M2 2h12v10H2z M2 4h12" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Postal Address
              </span>
            </div>
            <div style="padding-top: var(--spacing-sm); color: var(--color-text-primary);">
              ${formatAddress(postalAddress)}
            </div>
          </div>
        `;
      }

      html += '</div>';
      return html;
    }

    function formatAddress(address) {
      if (!address) return '<span class="text-tertiary">No address provided</span>';

      const parts = [];
      if (address.line1 || address.address1) parts.push(escapeHtml(address.line1 || address.address1));
      if (address.line2 || address.address2) parts.push(escapeHtml(address.line2 || address.address2));

      const cityLine = [];
      if (address.city) cityLine.push(escapeHtml(address.city));
      if (address.state) cityLine.push(escapeHtml(address.state));
      if (address.postalCode) cityLine.push(escapeHtml(address.postalCode));
      if (cityLine.length > 0) parts.push(cityLine.join(', '));

      if (address.country) parts.push(escapeHtml(address.country));

      return parts.length > 0
        ? parts.map(p => `<div>${p}</div>`).join('')
        : '<span class="text-tertiary">No address provided</span>';
    }

    function addressesEqual(addr1, addr2) {
      if (!addr1 || !addr2) return false;
      return JSON.stringify(addr1) === JSON.stringify(addr2);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // Listen for data from ChatGPT Apps SDK
    window.addEventListener('openai:set_globals', (event) => {
      console.log('[Fergus MCP] openai:set_globals event received');

      // Access customer directly from toolOutput (structuredContent is flattened)
      const toolOutput = event.detail?.globals?.toolOutput;
      const customer = toolOutput?.customer;

      console.log('[Fergus MCP] Customer data:', customer);
      if (customer) {
        render(customer);
      }
    });

    // Also render immediately if data is already available (for compatibility)
    const initialCustomer = window.openai?.toolOutput?.customer;
    if (initialCustomer) {
      console.log('[Fergus MCP] Initial customer data available:', initialCustomer);
      render(initialCustomer);
    }
  </script>
</body>
</html>
